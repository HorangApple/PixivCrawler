# PixivCrawler

### 1. 개요

수 많은 만화, 일러스트가 올라오는 일본의 pixiv에는 그림을 그리기에 유용한 팁들을 알려주는 게시글이 있다. 이 글은 대부분 여러 장의 그림으로 구성되어있다. 그림 공부를 하고싶은 사람에게는 감사하지만 한 장 한 장 다운로드 받기 귀찮은 건 사실이다. 그렇기 때문에 좀 더 손쉽게 다운로드를 하고자 이것을 개발하게 되었다.

#### 사용하기위해 설치해야하는  모듈

우선 사용하기 전에 설치가 필요한 모듈은 다음과 같다.

```bash
$ pip install BeautifulSoup4
$ pip install requests
$ pip install Pillow
```

`BeautifulSoup`와 `requests`모듈은 크롤링을, `Pillow`모듈은 이미지 병합을 하기위해 사용되었기에 이들의 모듈이 없으면 실행이 안되니 설치하자.

#### 사용방법

exe 실행파일을 눌러 여러 장의 이미지가 올라와 있는 픽시브 주소를 입력하고 이후의 옵션을 입력하면 된다.

입력할 픽시브 주소 예시는 다음과 같다.

```http
https://www.pixiv.net/member_illust.php?mode=medium&illust_id=50966337
```

게시글을 누르면 한 장의 이미지와 모두보기 버튼이 있는 페이지로 넘어가는데 그 주소를 입력하면 된다.

### 2. 코드에 대하여


#### 1) 주소 분석

예시를 들 게시글 주소는 다음과 같다.

```http
https://www.pixiv.net/member_illust.php?mode=medium&illust_id=50966337
```

여기서 접속하고 '모두보기'를 누르면 `mode` 값이 `manga`로 바뀌며 페이지에 여러 이미지를 볼 수 있도록 화면이 변경된다. 그리고 이미지 한 장씩 더 크게 본다면 다음과 같이 주소가 변경된다. 만약 게시글의 이미지가 한 장으로만 구성되어 있다면 여러 장이 아니기에 `mode=manga`로 볼 수 없어 pixiv 내 자체 오류가 발생한다. 지금 구현한 코드는 한 장으로 이루어진 게시글 대상으로 크롤링 할 수 없다.

```http
https://www.pixiv.net/member_illust.php?mode=manga_big&illust_id=50966337&page=0
```

`mode`가 `manga_big`으로 변경이 되었으며 한 장씩 보는 형식으로 변경되었기에 맨 뒤에 `&page=0`이 붙었다. `page`의 값에 따라 이후의 이미지를 볼 수 있을 것이다. 



다음으로 이미지 주소에 대해 알아보자. `mode=manga`일 때 이 게시글의 첫 번째 이미지 주소는 다음과 같다.

```http
https://i.pximg.net/img-master/img/2015/06/20/05/56/13/50966337_p0_master1200.jpg
```

여기서 `img-master` 부분을 `img-original`로 바꾸고 뒤에 있는 `_master1200`를 삭제하면 큰 사이즈의 이미지를 볼 수 있다. `original`이라는 만큼 원본 이미지라 추정된다.

pixiv의 게시글에 이미지가 표시되는 구조는 게시글에 들어가야 이미지가 표시가 되며 이미지 주소를 통해 접속하면 403 forbidden 오류가 뜬다. 가끔 오류가 일어나지 않고 이미지가 뜨는 것은 캐시로 저장된 이미지가 뜨는 것으로 실질적으로 요청을 통해 받아오는 것은 아니다.

게시글 주소에서 html 코드를 파씽할 때는 파라미터를 보낼 필요는 없으나 이미지 주소로 접속하려면 Referer 파라미터를 보내야한다. 그래야 `i.pximg.net`에 존재하는 게시글의 이미지를 받아올 수 있다.



#### 2) 파싱

이미지 주소의 규칙을 파악하여 적용하려고 했으나 위 예제의 이미지 주소처럼 `2015/06/20/05/56/13/`같은 몇 년도부터 몇 초로 만들어진 디렉터리가 포함되어 있기에 게시글을 통해 이미지 주소를 파악할 수 밖에 없었다.

파싱을 통해 얻어진 이미지 주소는 `mode=manga`인 주소들이었고 이후에 `replace`를 통한 텍스트 변경으로 사이즈가 큰 이미지의 주소로 변환시키는 함수를 별도로 만들었다.

이미지 한 장만 있는 게시글도 파싱을 해봤는데 `mode=manga`와는 이미지까지 도달하는 선택자가 달라서 현재 구현한 코드를 그대로 사용할 수 없었고 구현을 하게 된다면 별도의 함수로 만들어야한다.



#### 3) 이미지 다운로드 및 병합

이미지 다운로드를 하기위해 `shutil` 모듈을 사용했다. `images`폴더에 저장하도록 하였으며 만약에 폴더가 없으면 자동으로 생성하게끔 `os`모듈을 사용하였다.  

이미지 병합을 구현하기 위해 `PIL`(Pillow) 모듈을 사용하였다. 이 모듈은 이미지를 다루는 모듈로 알려져 있어 이미지의 x, y 값 획득부터 병합까지 구현할 수 있다. 병합에 대해 간단히 이야기하면 이미지 중 가장 긴 가로 길이와 모든 이미지의 세로 길이를 합한 값으로 구성된 흰색 바탕의 `canvas`를 별도로 그곳에 순차적으로 붙여 저장시키는 방법으로 진행된다. 크기가 서로 다르면 가로 이미지가 작은 이미지가 가운데에 배치시킬 수 있게 구현해놨고 흰 바탕에 붙이는 형식이기에 여백으로 채우기 편했다.



#### 4) 추후의 방향

일단 python GUI framework인 Kivy를 활용하여 미흡하나 GUI를 구현을 목표로 두고 있다. 구현하게 된다면 .exe 파일로 변환시켜 별도의 모듈을 설치하지 않고도 실행하도록 만들고 싶다.



### 3. History

190130

-  `url = inp.replace('mode=medium', 'mode=manga')` 를 통해 주소 변경을 하는데 만약 처음부터 `mode=manga`로 들어온다면 변경없이 `url`에 들어가는 줄 알았다. 왜냐하면 vscode나 pycharm에서 Run을 해서 작동시키면 실행이 되기 때문이다. 그런데 그것이 git bash를 통해 실행시키면 오류가 발생하는 원인인 것을 알게 되었고 if문을 사용하여 해결하였다. 하지만 이번에는 python bash로 실행시켜보면 안 된다.
-  그래서 `pyinstaller`를 이용하여 `.exe` 실행파일로 바꾸었다.

190128

- 첫 릴리즈
- 여러 장으로 구성된 페이지 주소를 받아서 다운로드
- 작은 이미지로 받을지, 원본에 준하는 큰 이미지로 받을지 선택가능
- 이미지 병합 기능 지원